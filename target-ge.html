<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Patient Reported Outcome</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #logo {
            margin-top: 20px;
            max-width: 300px;
        }
        #circle_image_container {
            position: relative;
            display: inline-block;
        }
        #circle_image {
            cursor: crosshair;
            max-width: 100%;
        }
        #punteggio_display {
            font-size: 2.5em;
            font-weight: bold;
            color: #004d99;
        }
    </style>
</head>
<body>

    <img src="logo-target.jpg" id="logo" alt="Logo Target">
    <div style="text-align: centre; margin-top: 10px; margin-left: 20px;">
        <a href="index.html" style="text-decoration: none; color: #004d99; font-size: 1.2em; font-weight: bold;">
            < Indietro
        </a>
    </div>

    <h1>Immagini che il centro del cerchio rappresenti lei stesso. Clicchi il punto che meglio descrive quanto sente che la malattia ha influenzato la sua vita negli ultimi sette giorni. Più vicino al centro significa un maggiore impatto, più lontano un impatto minore. </h1>
    <div id="circle_image_container">
        <img src="target-ge.jpg" id="circle_image">
    </div>

    <p>Punteggio: <span id="punteggio_display"></span></p>

    <hr>
    
    <h2>Inserisci i tuoi dati</h2>
    <div style="margin: 20px auto; max-width: 400px; text-align: left;">
        <div style="margin-bottom: 10px;">
            <label for="nome">Nome:</label>
            <input type="text" id="nome" required style="width: 100%;">
        </div>
        <div style="margin-bottom: 10px;">
            <label for="cognome">Cognome:</label>
            <input type="text" id="cognome" required style="width: 100%;">
        </div>
        <div style="margin-bottom: 10px;">
            <label for="data_nascita">Data di Nascita:</label>
            <input type="date" id="data_nascita" required style="width: 100%;">
        </div>
        <button id="invia_dati" style="padding: 10px 20px; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">Invia dati al clinico</button>
    </div>

    <script>
        let scoreValue = 0; // Variabile per memorizzare il punteggio

        document.getElementById('circle_image').addEventListener('click', function(event) {
            const img = event.target;
            const rect = img.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            
            const distance = Math.sqrt(Math.pow(clickX - centerX, 2) + Math.pow(clickY - centerY, 2));
            const maxRadius = Math.min(rect.width, rect.height) / 2;
            
            scoreValue = 10 - (10 * (distance / maxRadius));
            
            document.getElementById('punteggio_display').innerText = scoreValue.toFixed(2);
            
            // --- Codice per il puntino ---
            const oldDot = document.getElementById('click-dot');
            if (oldDot) {
                oldDot.remove();
            }
            const dot = document.createElement('div');
            dot.id = 'click-dot';
            dot.style.position = 'absolute';
            dot.style.width = '10px';
            dot.style.height = '10px';
            dot.style.backgroundColor = 'black';
            dot.style.borderRadius = '50%';
            dot.style.transform = 'translate(-50%, -50%)';
            dot.style.top = `${clickY}px`;
            dot.style.left = `${clickX}px`;
            document.getElementById('circle_image_container').appendChild(dot);
            // --- Fine codice per il puntino ---
        });

        document.getElementById('invia_dati').addEventListener('click', function() {
            const nome = document.getElementById('nome').value;
            const cognome = document.getElementById('cognome').value;
            const data_nascita = document.getElementById('data_nascita').value;

            if (nome && cognome && data_nascita && scoreValue > 0) {
                sendDataToRedcap(nome, cognome, data_nascita, scoreValue);
            } else {
                alert('Per favore, compila tutti i campi e clicca sul cerchio prima di inviare.');
            }
        });

        function sendDataToRedcap(nome, cognome, data_nascita, score) {
            const api_url = 'INSERISCI_URL_API_DI_REDCAP';
            const api_token = 'INSERISCI_TOKEN_API';
            const data = new FormData();
            data.append('token', api_token);
            data.append('content', 'record');
            data.append('format', 'json');
            data.append('type', 'flat');
            data.append('data', JSON.stringify([{
                'record_id': 'AUTO',
                'nome': nome,
                'cognome': cognome,
                'data_nascita': data_nascita,
                'punteggio_ge': score.toFixed(2) // Variabile per REDCap
            }]));

            fetch(api_url, {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(result => {
                console.log('Success:', result);
                alert('Dati inviati con successo!');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore nell\'invio dei dati.');
            });
        }
    </script>
    <hr>
    <p style="font-size: 0.8em; color: gray;">
        Questo progetto è un'idea del Dott. Andrea Lotesoriere. 
        È attualmente in corso uno studio di validazione presso l'Università di Ferrara.
        Tutti i diritti riservati.
    </p>

</body>
</html>

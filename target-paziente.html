<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Patient Reported Outcome - TARGET</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #logo {
            margin-top: 20px;
            max-width: 300px;
        }
        #t2t_section, #ge_section {
            display: block;
            margin-top: 20px;
        }
        #ge_section {
            display: none; /* Inizialmente nascosta */
        }
        #circle_image_container {
            position: relative;
            display: inline-block;
        }
        #circle_image_t2t {
            cursor: crosshair;
            max-width: 100%;
        }
        #punteggio_t2t_display, #punteggio_ge_display {
            font-size: 2.5em;
            font-weight: bold;
            color: #004d99;
        }
        .likert-scale {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .likert-option {
            background-color: #f1f1f1;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s, transform 0.3s;
        }
        .likert-option:hover {
            background-color: #ddd;
            transform: scale(1.1);
        }
        .likert-option.selected {
            background-color: #007bff;
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>
<body>

    <img src="logo-target.jpg" id="logo" alt="Logo Target">
    <div style="text-align: center; margin-top: 10px; margin-left: 20px;">
        <a href="index.html" style="text-decoration: none; color: #004d99; font-size: 1.2em; font-weight: bold;">
            < Indietro
        </a>
    </div>

    <div id="t2t_section">
        <h1>Immagini che il centro del cerchio rappresenti il pieno raggiungimento del successo con la terapia. Clicchi sul punto del cerchio che meglio descrive quanto sente di aver raggiunto questo obiettivo con la terapia che sta attualmente assumendo. Più vicino al centro significa un maggior successo della terapia. </h1>
        <div id="circle_image_container_t2t">
            <img src="target2.01.jpg" id="circle_image_t2t">
        </div>

        <p>Punteggio: <span id="punteggio_t2t_display"></span></p>

        <hr>

        <h2>Inserisci i tuoi dati</h2>
        <div style="margin: 20px auto; max-width: 400px; text-align: left;">
            <div style="margin-bottom: 10px;">
                <label for="nome">Nome:</label>
                <input type="text" id="nome" required style="width: 100%;">
            </div>
            <div style="margin-bottom: 10px;">
                <label for="cognome">Cognome:</label>
                <input type="text" id="cognome" required style="width: 100%;">
            </div>
            <div style="margin-bottom: 10px;">
                <label for="data_nascita">Data di Nascita:</label>
                <input type="date" id="data_nascita" required style="width: 100%;">
            </div>
            <button id="invia_t2t" style="padding: 10px 20px; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">Invia dati T2T</button>
        </div>
    </div>

    <div id="ge_section">
        <h1>Immagini che il centro del cerchio rappresenti lei stesso. Clicchi il punto che meglio descrive quanto sente che la malattia ha influenzato la sua vita negli ultimi sette giorni. Più vicino al centro significa un maggiore impatto, più lontano un impatto minore. </h1>
        <div id="circle_image_container_ge">
            <img src="target-ge.jpg" id="circle_image_ge">
        </div>

        <p>Punteggio: <span id="punteggio_ge_display"></span></p>

        <hr>
        
        <button id="invia_ge" style="padding: 10px 20px; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; max-width: 400px;">Invia dati GE al clinico</button>

        <div id="likert_section" style="display:none; margin-top: 50px;">
            <h2>Valutazione del formato digitale</h2>
            <p>In una scala da 1 a 5, quanto ti è piaciuto il formato digitale di questi questionari?</p>
            <p>(1 = Per niente, 5 = Moltissimo)</p>
            <div class="likert-scale">
                <div class="likert-option" data-value="1">1</div>
                <div class="likert-option" data-value="2">2</div>
                <div class="likert-option" data-value="3">3</div>
                <div class="likert-option" data-value="4">4</div>
                <div class="likert-option" data-value="5">5</div>
            </div>
            <button id="invia_likert" style="margin-top: 20px; padding: 10px 20px; font-size: 1em; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; max-width: 400px;">Invia valutazione</button>
        </div>
    </div>
    
    <hr>
    <p style="font-size: 0.8em; color: gray;">
        Questo progetto è un'idea del Dott. Andrea Lotesoriere.
        È attualmente in corso uno studio di validazione presso l'Università di Ferrara.
        Tutti i diritti riservati.
    </p>

    <script>
        let punteggioT2T = 0;
        let punteggioGE = 0;
        let punteggioLikert = 0;
        let recordId = null;

        // Logica per il questionario T2T
        document.getElementById('circle_image_t2t').addEventListener('click', function(event) {
            const img = event.target;
            const rect = img.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;

            const distance = Math.sqrt(Math.pow(clickX - centerX, 2) + Math.pow(clickY - centerY, 2));
            const maxRadius = Math.min(rect.width, rect.height) / 2;

            punteggioT2T = 10 - (10 * (distance / maxRadius));
            document.getElementById('punteggio_t2t_display').innerText = punteggioT2T.toFixed(2);

            const oldDot = document.getElementById('click-dot');
            if (oldDot) oldDot.remove();
            const dot = document.createElement('div');
            dot.id = 'click-dot';
            dot.style.position = 'absolute';
            dot.style.width = '10px';
            dot.style.height = '10px';
            dot.style.backgroundColor = 'black';
            dot.style.borderRadius = '50%';
            dot.style.transform = 'translate(-50%, -50%)';
            dot.style.top = `${clickY}px`;
            dot.style.left = `${clickX}px`;
            document.getElementById('circle_image_container_t2t').appendChild(dot);
        });

        document.getElementById('invia_t2t').addEventListener('click', function() {
            const nome = document.getElementById('nome').value;
            const cognome = document.getElementById('cognome').value;
            const data_nascita = document.getElementById('data_nascita').value;

            if (nome && cognome && data_nascita && punteggioT2T > 0) {
                sendT2TDataToRedcap(nome, cognome, data_nascita, punteggioT2T);
            } else {
                alert('Per favore, compila tutti i campi e clicca sul cerchio T2T prima di inviare.');
            }
        });

        function sendT2TDataToRedcap(nome, cognome, data_nascita, score) {
            const api_url = 'https://redcap.ospfe.it/redcap_v14.5.20/API/';
            const api_token = '45F6836488C93C92B59235B34407945F';
            const data = new FormData();
            data.append('token', api_token);
            data.append('content', 'record');
            data.append('format', 'json');
            data.append('type', 'flat');
            data.append('data', JSON.stringify([{
                'record_id': 'AUTO',
                'nome': nome,
                'cognome': cognome,
                'data_nascita': data_nascita,
                'punteggio_t2t': score.toFixed(2)
            }]));

            fetch(api_url, {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(result => {
                console.log('Success:', result);
                if (result.count === 1) { 
                    recordId = result.id;
                    alert('Dati T2T inviati con successo! Ora compila il prossimo questionario.');
                    document.getElementById('t2t_section').style.display = 'none';
                    document.getElementById('ge_section').style.display = 'block';
                } else {
                    alert('Errore nella creazione del record su REDCap.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore nell\'invio dei dati.');
            });
        }
        
        // Logica per il questionario GE
        document.getElementById('circle_image_ge').addEventListener('click', function(event) {
            const img = event.target;
            const rect = img.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;

            const distance = Math.sqrt(Math.pow(clickX - centerX, 2) + Math.pow(clickY - centerY, 2));
            const maxRadius = Math.min(rect.width, rect.height) / 2;

            punteggioGE = 10 - (10 * (distance / maxRadius));
            document.getElementById('punteggio_ge_display').innerText = punteggioGE.toFixed(2);

            const oldDot = document.getElementById('click-dot-ge');
            if (oldDot) oldDot.remove();
            const dot = document.createElement('div');
            dot.id = 'click-dot-ge';
            dot.style.position = 'absolute';
            dot.style.width = '10px';
            dot.style.height = '10px';
            dot.style.backgroundColor = 'black';
            dot.style.borderRadius = '50%';
            dot.style.transform = 'translate(-50%, -50%)';
            dot.style.top = `${clickY}px`;
            dot.style.left = `${clickX}px`;
            document.getElementById('circle_image_container_ge').appendChild(dot);
        });

        document.getElementById('invia_ge').addEventListener('click', function() {
            if (punteggioGE > 0) {
                if (recordId) {
                    sendGEDataToRedcap(recordId, punteggioGE);
                } else {
                    alert('Errore: l\'ID del record non è stato trovato. Si prega di ricominciare.');
                }
            } else {
                alert('Per favore, clicca sul cerchio GE prima di inviare.');
            }
        });

        function sendGEDataToRedcap(id, score) {
            const api_url = 'https://redcap.ospfe.it/redcap_v14.5.20/API/';
            const api_token = '45F6836488C93C92B59235B34407945F';
            const data = new FormData();
            data.append('token', api_token);
            data.append('content', 'record');
            data.append('format', 'json');
            data.append('type', 'flat');
            data.append('data', JSON.stringify([{
                'record_id': id,
                'punteggio_ge': score.toFixed(2)
            }]));

            fetch(api_url, {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(result => {
                console.log('Success:', result);
                alert('Dati GE inviati con successo! Ora rispondi alla valutazione finale.');
                document.getElementById('likert_section').style.display = 'block';
                document.getElementById('invia_ge').disabled = true;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore nell\'invio dei dati.');
            });
        }
        
        // Logica per la scala Likert
        document.querySelectorAll('.likert-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.likert-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                punteggioLikert = this.getAttribute('data-value');
            });
        });

        document.getElementById('invia_likert').addEventListener('click', function() {
            if (punteggioLikert > 0) {
                if (recordId) {
                    sendLikertDataToRedcap(recordId, punteggioLikert);
                } else {
                    alert('Errore: l\'ID del record non è stato trovato. Si prega di ricominciare.');
                }
            } else {
                alert('Per favore, seleziona un punteggio prima di inviare.');
            }
        });
        
        function sendLikertDataToRedcap(id, score) {
            const api_url = 'https://redcap.ospfe.it/redcap_v14.5.20/API/';
            const api_token = '45F6836488C93C92B59235B34407945F';
            const data = new FormData();
            data.append('token', api_token);
            data.append('content', 'record');
            data.append('format', 'json');
            data.append('type', 'flat');
            data.append('data', JSON.stringify([{
                'record_id': id,
                'gradimento_digitale': score
            }]));

            fetch(api_url, {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(result => {
                console.log('Success:', result);
                alert('Grazie per la tua valutazione!');
                document.getElementById('invia_likert').disabled = true;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore nell\'invio della valutazione.');
            });
        }
    </script>

</body>
</html>
